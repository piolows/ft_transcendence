services:
  # Init container to set proper ownership
  volume-init:
    image: alpine:latest
    command: |
      sh -c "
        chmod -R 777 /front_end /backend_controller /backend_auth /backend_users /backend_games
      "
    volumes:
      - front_end:/front_end
      - backend_controller:/backend_controller
      - backend_auth:/backend_auth
      - backend_users:/backend_users
      - backend_games:/backend_games
      - backend_assets:/backend_assets

  frontend:
    container_name: frontend
    volumes:
      - front_end:/app
    build: ./frontend
    restart: on-failure
    environment:
      - NODE_ENV=development
    ports:
      - "443:443"
    networks:
      - transcendence

  backend:
    container_name: backend
    volumes:
      - backend_controller:/app
    build: ./backend/controller
    restart: on-failure
    environment:
      - NODE_ENV=development
      - PORT=4161
      - FRONTEND_URL=https://localhost
      - AUTH_URL=http://backend_auth:41610
      - USER_URL=http://backend_users:41611
      - GAME_URL=http://backend_games:41612
    ports:
      - "4161:4161"
    networks:
      - transcendence
      - micro-services

  backend_auth:
    container_name: backend_auth
    volumes:
      - backend_auth:/app
    build: ./backend/auth
    restart: on-failure
    environment:
      - NODE_ENV=development
      - PORT=41610
      - SESSIONS_DB=/app/src/database/sessions.db
      - DB_FILE=/app/src/database/auth.db
      - USERS_TABLE=users
      - DEFAULT_PIC=https://lumiere-a.akamaihd.net/v1/images/character_themuppets_kermit_b77a431b.jpeg
      - SESSION_SECRET=${SESSION_SECRET}
    networks:
      - micro-services

  backend_users:
    container_name: backend_users
    volumes:
      - backend_users:/app
    build: ./backend/users
    restart: on-failure
    environment:
      - NODE_ENV=development
      - PORT=41611
      - DB_FILE=/app/src/database/users.db
      - USERS_TABLE=users
    networks:
      - micro-services

  backend_games:
    container_name: backend_games
    volumes:
      - backend_games:/app
    build: ./backend/games
    restart: on-failure
    environment:
      - NODE_ENV=development
      - PORT=41612
      - DB_FILE=/app/src/database/games.db
      - GAMES_TABLE=games
    networks:
      - micro-services

  backend_assets:
    container_name: backend_assets
    build: ./backend/assets
    volumes:
      - backend_assets:/app
    restart: on-failure
    # environment:
    networks:
      - micro-services

volumes:
  front_end:
    name: front_end
    driver: local
    driver_opts:
      type: none
      device: ${PWD}/frontend/app
      o: bind
  backend_users:
    name: backend_users
    driver: local
    driver_opts:
      type: none
      device: ${PWD}/backend/users/app
      o: bind
  backend_auth:
    name: backend_auth
    driver: local
    driver_opts:
      type: none
      device: ${PWD}/backend/auth/app
      o: bind
  backend_controller:
    name: backend_controller
    driver: local
    driver_opts:
      type: none
      device: ${PWD}/backend/controller/app
      o: bind
  backend_games:
    name: backend_games
    driver: local
    driver_opts:
      type: none
      device: ${PWD}/backend/games/app
      o: bind
  backend_assets:
    name: backend_assets
    driver: local
    driver_opts:
      type: none
      device: ${PWD}/backend/assets/app
      o: bind

networks:
  transcendence:
    name: transcendence
    driver: bridge
  micro-services:
    name: micro-services
    driver: bridge
